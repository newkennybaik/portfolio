{"version":3,"file":"static/js/479.b8b00210.chunk.js","mappings":"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","sources":["banuba/BanubaPlugin.js"],"sourcesContent":["import {\n  Effect,\n  MediaStream as BanubaMediaStream,\n  MediaStreamCapture,\n  Player,\n  Dom,\n  Module,\n} from \"@banuba/webar\";\nimport wasm from \"@banuba/webar/BanubaSDK.wasm\";\nimport simd from \"@banuba/webar/BanubaSDK.simd.wasm\";\nimport data from \"@banuba/webar/BanubaSDK.data\";\n\n// import FaceTracker from \"@banuba/webar/face_tracker.zip?url\";\nimport Background from \"@banuba/webar/background.zip?url\";\nimport { loadScript } from \"utils/loaders.js\";\n\n// SDK version 1.7.1\n// effect stored in public/banuba folder\n// docs: https://docs.banuba.com/face-ar-sdk-v1/generated/typedoc/\n\nexport async function initBanubaPlugin() {\n  const params = new URLSearchParams(window.location.search);\n  const effectParam = params.get(\"effect\") || \"Camera_background\";\n  let isTokenValid;\n\n  const playerId = `webar_${new Date().valueOf()}`;\n  if (window.isSafariBrowser)\n    navigator.serviceWorker.register(\"banuba/range-requests.sw.js\");\n\n  let player, modules;\n  await loadScript(\"banuba/token.js\");\n  const banubaToken = window.banubaToken;\n  try {\n    [player, modules] = await Promise.all([\n      Player.create({\n        locateFile: {\n          \"BanubaSDK.data\": data,\n          \"BanubaSDK.wasm\": wasm,\n          \"BanubaSDK.simd.wasm\": simd,\n        },\n        clientToken: banubaToken,\n        devicePixelRatio: 1,\n        proxyVideoRequestsTo: window.isSafariBrowser\n          ? \"___range-requests___/\"\n          : null,\n      }),\n      Module.preload([Background]),\n    ]);\n\n    await player.addModule(...modules);\n    window.isBanubaTokenValid = true;\n    isTokenValid = true;\n  } catch (e) {\n    console.error(e);\n    window.isBanubaTokenValid = false;\n    isTokenValid = false;\n  }\n\n  const isTokenValidEvent = new CustomEvent(\"BanubaTokenValid\", {\n    bubbles: true,\n    detail: { isValid: isTokenValid },\n  });\n  window.document.body.dispatchEvent(isTokenValidEvent);\n\n  if (!player || !isTokenValid) return;\n  // await new Promise((resolve) => setTimeout(resolve, 15000)); // please do not remove, we need it for testing loading delay\n\n  const effect = await Effect.preload(`banuba/${effectParam}.zip`);\n\n  const playerElement = document.createElement(\"div\");\n  playerElement.id = playerId;\n  playerElement.style = `\n     position: absolute !important;\n     top: -9999px !important;\n     left: -9999px !important;\n     display: !important;\n   `;\n  document.body.appendChild(playerElement);\n\n  let _isBanubaInited = false;\n  const store = localStorage.getItem(\"VIDYO_CONNECT\");\n  let selectedCameraEffect;\n  if (store) {\n    selectedCameraEffect = JSON.parse(store).selectedCameraEffect;\n  }\n  if (selectedCameraEffect) {\n    await player.applyEffect(effect);\n\n    if (selectedCameraEffect.id === \"blur\") {\n      effect.evalJs(\"Background.blur(0.6)\");\n      _isBanubaInited = true;\n    } else {\n      effect.evalJs(`Background.texture('${selectedCameraEffect.name}.jpg')`);\n      _isBanubaInited = true;\n    }\n  }\n\n  let streams = [];\n  let lastStream = null;\n\n  const clearStream = (stream) => {\n    if (stream) {\n      stream.getVideoTracks().forEach((track) => {\n        track.stop();\n      });\n    }\n  };\n\n  window.banuba = {\n    get isBanubaInited() {\n      return _isBanubaInited;\n    },\n    clearEffect: () => player.clearEffect(),\n    applyEffect: async (imageName) => {\n      _isBanubaInited = true;\n      await player.applyEffect(effect);\n\n      if (imageName === \"blur\") {\n        effect.evalJs(\"Background.blur(0.6)\");\n      } else {\n        effect.evalJs(`Background.texture('${imageName}.jpg')`);\n      }\n    },\n    effectBackground: async (stream, useCache) => {\n      if (!_isBanubaInited) return stream;\n      if (lastStream?.active && useCache) {\n        // applicable only for self-view\n        clearStream(stream);\n        const clonedEffectStream = lastStream.clone();\n        console.log(\n          `BANUBA: Called effectBackground for ${stream.id} and get effectedStreamCapture ${clonedEffectStream.id} from cache`\n        );\n        return clonedEffectStream;\n      }\n\n      let checkOrinetationOnSafari =\n        window.isSafariBrowser && window.isMobileOrTablet && useCache;\n\n      player.use(new BanubaMediaStream(stream), {\n        resize: (width, height) => {\n          try {\n            // workaround for issue with squeezed self-view on ios Safari (only for our self-view)\n            if (checkOrinetationOnSafari) {\n              const isPortraitOrientation =\n                window.screen?.orientation?.type?.startsWith?.(\"portrait\");\n              if (\n                isPortraitOrientation ||\n                (isPortraitOrientation === undefined &&\n                  window.innerHeight > window.innerWidth)\n              ) {\n                if (width > height) return [height, width];\n              }\n            }\n          } catch (e) {\n            console.error(\n              \"BANUBA: error during cheking screen orientation on ios Safari\"\n            );\n            checkOrinetationOnSafari = false;\n            return [width, height];\n          }\n          return [width, height];\n        },\n        horizontalFlip: false,\n      });\n      if (document.querySelector(`#${playerId} canvas`))\n        Dom.unmount(`#${playerId}`);\n      Dom.render(player, `#${playerId}`);\n\n      let effectStream;\n      // if (window.isSafariBrowser) {\n      //   // Temporary part fix for safari, for issue wtih black selfview at the beginning\n      //   // It looks like some issue with MediaStreamCapture\n      //   effectStream = document\n      //     .querySelector(`#${playerId} canvas`)\n      //     ?.captureStream?.();\n      // }\n      if (!effectStream?.active) effectStream = new MediaStreamCapture(player);\n      effectStream.addEventListener(\"inactive\", () => {\n        clearStream(stream);\n      });\n      streams.push(stream);\n      lastStream = effectStream;\n      console.log(\n        `BANUBA: Called effectBackground for ${stream.id} and get fresh effectedStreamCapture ${effectStream.id}`\n      );\n\n      // small delay for skipping first frame that can remain from previous stream in the player.\n      await new Promise((resolve) => setTimeout(resolve, 200));\n\n      return effectStream;\n    },\n    getLastStream: () => {\n      const clonedEffectStream = lastStream?.clone();\n      console.log(\n        `BANUBA: Called getLastStream and get ${\n          clonedEffectStream ? clonedEffectStream.id : \"null\"\n        } from cache. LastStream is ${lastStream ? lastStream.id : \"null\"}`\n      );\n      return clonedEffectStream;\n    },\n    stopStreams: () => {\n      console.log(\n        `BANUBA: Stop cached streams ${[lastStream, ...streams]\n          .map((s) => s?.id || \"\")\n          .join(\",\")}`\n      );\n      [lastStream, ...streams].forEach((stream) => {\n        clearStream(stream);\n      });\n      streams = [];\n      lastStream = null;\n    },\n  };\n\n  window.banubaPluginReady = true;\n  const event = new Event(\"BanubaPluginReady\", { bubbles: true });\n  window.document.body.dispatchEvent(event);\n  return true;\n}\n"],"names":["async","initBanubaPlugin","effectParam","URLSearchParams","window","location","search","get","isTokenValid","playerId","concat","Date","valueOf","player","modules","isSafariBrowser","navigator","serviceWorker","register","loadScript","banubaToken","Promise","all","Player","create","locateFile","data","wasm","simd","clientToken","devicePixelRatio","proxyVideoRequestsTo","Module","preload","Background","addModule","isBanubaTokenValid","e","console","error","isTokenValidEvent","CustomEvent","bubbles","detail","isValid","document","body","dispatchEvent","effect","Effect","playerElement","createElement","id","style","appendChild","_isBanubaInited","store","localStorage","getItem","selectedCameraEffect","JSON","parse","applyEffect","evalJs","name","streams","lastStream","clearStream","stream","getVideoTracks","forEach","track","stop","banuba","isBanubaInited","clearEffect","imageName","effectBackground","useCache","_lastStream","_effectStream","active","clonedEffectStream","clone","log","effectStream","checkOrinetationOnSafari","isMobileOrTablet","use","BanubaMediaStream","resize","width","height","_window$screen","_window$screen$orient","_window$screen$orient2","_window$screen$orient3","isPortraitOrientation","screen","orientation","type","startsWith","call","undefined","innerHeight","innerWidth","horizontalFlip","querySelector","Dom","unmount","render","MediaStreamCapture","addEventListener","push","resolve","setTimeout","getLastStream","_lastStream2","stopStreams","map","s","join","banubaPluginReady","event","Event"],"sourceRoot":""}