# Mail/Antispam Server Overview
Install two mail servers with shared NFS storage for redundant email delivery and high availability.

1. Mail Server Installation
2. Anti-spam Server Installation
3. HA/Redundancy Setting via storage server
4. Internal Testing

# Steps

## 0. 고정 IP 세팅
```bash
# nmtui

[Edit Connection - ens160]
IPv4 192.168.136.0/24
subnet mask 255.255.255.0
Gateway 192.168.136.2
dns 8.8.8.8, 168.126.63.1 // 추후 dns서버 추가

[Deactivate - Activate]
```

## 1. Mail Server Installation

### 1.1 필수 OS 라이브러리 설치
```bash
# yum -y install glibc.i686
# yum -y install libgcc.i686
# yum -y install libstdc++.i686
# yum -y install gd.x86_64 gd-devel.x86_64
# yum -y install gd.i686 gd-devel.i686
# yum -y install libnsl.i686
# yum -y install ntsysv
# yum -y install libxcrypt.i686
# yum -y install libxcrypt-devel.i686
# yum -y install epel-release
# yum -y install initscripts
# yum -y install nfs-utils
# yum -y install telnet
```

### 1.2 OS 설정

#### 1.2.1 SELINUX disable 처리
```bash
# vi /etc/selinux/config

[/etc/selinux/config]
SELINUX=disabled

# setenforce 0 && getenforce
```

#### 1.2.2 OS 계정 추가 및 권한 설정 (tomcat)
```bash
# useradd -u 1000 -g 1000 tomcat

# visudo
[/etc/sudoers]
tomcat ALL=NOPASSWD:ALL, !SHUTDOWN

[/etc/sudoers.d/tomcat]
tomcat ALL=NOPASSWD:ALL, !SHUTDOWN
```

#### 1.2.3 시간 자동 동기화
```bash
# yum -y install chrony

# systemctl enable chronyd --now

# vi /etc/chrony.conf
[/etc/chrony.conf]
server time.google.com iburst

# systemctl restart chronyd

# chronyc sources
 chronyc sources
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^+ 121.174.142.82                3   6    17     4   +338us[ +815us] +/-   30ms
^+ any.time.nl                   2   6    17     4   +163us[ +639us] +/-   20ms
^* 106.247.248.106               2   6    17     4   +915us[+1392us] +/-   26ms
^- 121.174.142.81                3   6    17     3   +492us[ +492us] +/-   31ms
^+ time2.google.com              1   6    17     4  -4412us[-4412us] +/-   30ms

# crontab -e
  0 * * * * /usr/bin/chronyc makestep && /sbin/hwclock --systohc // 주기적 하드웨어 시간 동기화

# date && hwclock --show
Thu Mar 13 10:02:36 KST 2025
2025-03-13 10:02:36.013664+09:00
```

#### 1.2.4 방화벽 중지
```bash
# systemctl stop firewalld
# sytemctl disable firewalld
```

#### 1.2.5 혹은 설정을 아래 스크립트로 자동화 처리
```bash
#!/bin/bash

PACKAGES="sysstat initscripts gd.x86_64 gd-devel.x86_64 gd.i686 gd-devel.i686 bash-completion tcpdump telnet lsof iputils bind-utils net-tools sqlite ntsysv"
OS_NAME=$(cat /etc/*release | grep "NAME" | cut -d = -f 2 | tr -d '"' | head -n 1 | cut -d " " -f1)


if [ "$OS_NAME" == "Rocky" ]; then
dnf -y install $PACKAGES
elif [ "$OS_NAME" == "CentOS" ]; then
yum -y install $PACKAGES
fi

#firewalld, postfix disable
systemctl stop firewalld postfix
systemctl disable firewalld postfix


#selinux disable
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
setenforce 0

#tomcat 계정 권한
chmod u+w /etc/sudoers
echo "tomcat    ALL=NOPASSWD:ALL,  !SHUTDOWN" | tee -a /etc/sudoers > /dev/null
echo "Cmnd_Alias SHUTDOWN = /sbin/shutdown" | tee -a /etc/sudoers > /dev/null
chmod u-w /etc/sudoers
touch /etc/sudoers.d/tomcat
echo "tomcat ALL=NOPASSWD:ALL, !SHUTDOWN" | tee -a /etc/sudoers.d/tomcat > /dev/null
chmod 0440 /etc/sudoers.d/tomcat

#sqlite3 쿼리 출력 모드 설정
echo -e ".mode line\n.headers on" > ~/.sqliterc

#open file limit 해제
echo "*     soft     nofile     65535" | tee -a /etc/security/limits.conf
echo "*     hard     nofile     65535" | tee -a /etc/security/limits.conf

#history에 시간 설정
echo "HISTTIMEFORMAT=\"[%F %T %Z] \"" >> /etc/profile
source /etc/profile

#네트워크튜닝
echo "4194303"  > /proc/sys/net/core/rmem_default
echo "16777215"  > /proc/sys/net/core/rmem_max
echo "4194303"  > /proc/sys/net/core/wmem_default
echo "16777215 " > /proc/sys/net/core/wmem_max
echo "100000"  > /proc/sys/net/core/netdev_max_backlog
echo "4194303"  > /proc/sys/net/core/optmem_max
echo "1048576   16777216   33554432"  > /proc/sys/net/ipv4/tcp_rmem
echo "1048576   16777216   33554432"  > /proc/sys/net/ipv4/tcp_wmem

#시간은 초단위이고 기본값은 60이다.  대량의 요청이 발생한다면 10초 정도로 맞춰주는게 권장값이다.
echo "net.ipv4.tcp_fin_timeout = 30" | tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_tw_recycle= 1 " | tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_tw_reuse= 1 " | tee -a /etc/sysctl.conf
```

### 1.3 퀄리티아 메일패키지 설치 및 실행(스팸 동일)
```bash
# tar -xvpzf package.tar.gz && cd package

# ./installer

# /install_path/apahce-tomcat-*.*.**/bin/catalina.sh start

# ps -ef | grep java // 톰캣 실행 여부 확인
```

### 1.4 두번째 서버인 Slave도 설치 방법은 위와 동일

## 2. antispam 서버 설치 - 메일서버와 동일함

## 3. Storage Server Setting

### 3.1 NFS 필수 라이브러리 설치 및 실행 (메일서버에도 설치해야함)
```bash
# useradd -u 1000 -g 1000 tomcat
# yum -y install nfs-utils
# yum -y install cifs-utils

# systemctl start rpcbind
# systemctl start nfs-server // 공유주체인 스토리지 서버만
# systemctl enable rpcbind
# systemctl enable nfs-server
```

### 3.2 공유 폴더 생성 및 마운트 설정

#### 3.2.0 VMware에 디스크 추가 (가상머신설정)
1. VM 전원을 끈 상태에서 VM 선택 → 우클릭 → Settings (설정)
2. 하드웨어 탭에서 → [Add] 클릭
3. Hard Disk 선택 → Next
4. nvme 선택 (기본) → Next
5. Create a new virtual disk → Next
6. 디스크 크기 입력 (20 GB) 
	Storage 방식: Split 또는 Single file (기본값 그대로 OK)
	디스크 위치 및 이름: 기본값 또는 원하는 이름
7. 완료 후 → 디스크가 추가됨 (보통 /dev/nvme0n2)

#### 3.2.1 물리 볼륨 생성 및 VG(볼륨그룹-rl)에 디스크 추가
- 실제 공간 할당은 PV -> VG -> LV -> 파일시스템 생성(ext4) -> 마운트 -> fstab순으로 추가하면 됨
```bash
# lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sr0          11:0    1  1.8G  0 rom
nvme0n1     259:0    0   20G  0 disk
├─nvme0n1p1 259:1    0    1G  0 part /boot
└─nvme0n1p2 259:2    0   19G  0 part
  ├─rl-root 253:0    0   17G  0 lvm  /
  └─rl-swap 253:1    0    2G  0 lvm  [SWAP]
nvme0n2     259:3    0   20G  0 disk

# pvcreate /dev/nvme0n2
  Physical volume "/dev/nvme0n2" successfully created.

# vgextend rl /dev/nvme0n2
  Volume group "rl" successfully extended

# vgs
  VG #PV #LV #SN Attr   VSize  VFree
  rl   2   2   0 wz--n- 38.99g <20.00g	//VFree가 기존에는 0이었다가 지금은 20G로 늘었음
```

#### 3.2.2 논리 볼륨 생성 (10GB) 및 파일시스템 생성(ext4)
```bash
# lvcreate -n lv_shared -L 10G rl
  Logical volume "lv_shared" created.

# mkfs.ext4 /dev/rl/lv_shared
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 2621440 4k blocks and 655360 inodes
Filesystem UUID: fbfa7fe8-b183-4db7-92af-06d5ee3c8fef
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done
```

#### 3.2.3 /mnt 폴더로 마운트 및 fstab 등
```bash
# mkdir -p /mnt
# mount /dev/rl/lv_shared /mnt

# df -h
Filesystem                Size  Used Avail Use% Mounted on
devtmpfs                  4.0M     0  4.0M   0% /dev
tmpfs                     1.8G     0  1.8G   0% /dev/shm
tmpfs                     726M  9.1M  717M   2% /run
/dev/mapper/rl-root        17G  1.4G   16G   8% /
/dev/nvme0n1p1            960M  231M  730M  25% /boot
tmpfs                     363M     0  363M   0% /run/user/0
/dev/mapper/rl-lv_shared  9.8G   24K  9.3G   1% /mnt

# echo "/dev/rl/lv_mnt /mnt ext4 defaults 0 0" | sudo tee -a /etc/fstab
```
#### 3.2.4 공유폴더 생성 및 메일서버에서 마운트
```bash
# mkdir /mnt/maildata && mkdir /mnt/spamdata
# cd /mnt && chown -R tomcat:tomcat *data

(공유 폴더의 역할을 하려면 메일서버의 tomcat 권한과 동일한 권한을 유지한채로 마운트해야하며, no_root_sqush 옵션을 줘야함)

# vi /etc/exports
[/etc/exports]
/mnt/maildata *(rw,sync,no_root_squash)
/mnt/spamdata *(rw,sync,no_root_squash)

# exportfs -ra
# exportfs -v
/mnt/maildata   <world>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)
/mnt/spamdata   <world>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)

# showmount -e 192.168.136.130
Export list for 192.168.136.130:
/mnt/spamdata *
/mnt/maildata *

# systemctl stop firewalld
# systemctl disable firewalld
```

### 3.3 메일서버에서 마운트

#### 3.3.1 fstab을 이용한 부팅 시 자동 마운트 설정.
```bash
# vi /etc/fstab
[/etc/fstab]
192.168.136.128:/mnt/maildata/	/usr/local/DEEPSoft/Postian/shared   nfs   defaults,_netdev  0 0
192.168.136.138:/mnt/spamdata/	/usr/local/DEEPSoft/WBlockG5/shared   nfs   defaults,_netdev  0 0

(_netdev 옵션을 줘서 네트워크가 살아난 뒤 마운트되도록 보장. defaults 옵션에는 기본적으로 rw,suid,dev,exec,auto,nouser,async 포함되어 있음)
```

#### 3.3.2 메일서버에서 스토리지 서버의 공유폴더 마운트
```bash
# mount -t nfs 192.168.136.130:/mnt/maildata/ /usr/local/DEEPSoft/Postian/shared
# mount -t nfs 192.168.136.130:/mnt/spamdata/ /usr/local/DEEPSoft/WBlockG5/shared

# df -h
Filesystem                     Size  Used Avail Use% Mounted on
devtmpfs                       4.0M     0  4.0M   0% /dev
tmpfs                          1.8G     0  1.8G   0% /dev/shm
tmpfs                          726M  9.1M  717M   2% /run
/dev/mapper/rl-root             36G  4.8G   31G  14% /
/dev/nvme0n1p1                 960M  231M  730M  25% /boot
tmpfs                          363M     0  363M   0% /run/user/0
192.168.136.130:/mnt/maildata   17G  1.4G   16G   8% /usr/local/DEEPSoft/Postian/shared
192.168.136.130:/mnt/spamdata   17G  1.4G   16G   8% /usr/local/DEEPSoft/WBlockG5/shared
```

### 3.3.3 메일서버에서 데이터 공유를 위한 내부 설정(비공개)