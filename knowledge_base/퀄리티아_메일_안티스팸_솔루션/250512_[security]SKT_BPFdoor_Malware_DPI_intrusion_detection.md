# Deep Packet Inspection(DPI) & Intrusion Detection Analysis overview
- SKT 정보유출 사건 관련 하여 이슈사항 고객 요청사항 정리
- 리눅스에서 백도어(BPF도어) 악성코드 탐지 및 네트워크 행위 분석을 위한 고전적이고 효과적인 방법에 대해서 정리하고자 함.

BPF도어 특징:
(1) 해당 악성코드는 방화벽을 우회해서 수상한 포트나 PID를 통해 은밀하게 접속해서 정보를 탈취하는 성질을 갖고 있음.
(2) 네트워크 패킷이나 특정 IP/포트를 통해 침투할 가능성이 유력하기 때문에 OS Level에서 raw 패킷 검사를 진행함.
(3) Rocky Linux release 9.4 (Blue Onyx) 기준으로 기록

# Steps

## 1. 비정상 네트워크 연결 확인
### 1.1 ss 명령어
설명: 내부 루프백과 정상적인 서비스 포트를 제외하고, 연결된 의심스러운 외부 IP와 포트 확인
목적: BPFdoor가 사용하는 비표준 포트 감지

```bash
# ss -antup | grep -vE '127.0.0.1|:22|:25|:80|:443'
Netid State      Recv-Q Send-Q          Local Address:Port            Peer Address:Port Process
udp   UNCONN     0      0                     0.0.0.0:38318                0.0.0.0:*
udp   UNCONN     0      0                     0.0.0.0:20048                0.0.0.0:*     users:(("rpc.mountd",pid=894,fd=4))
udp   UNCONN     0      0                     0.0.0.0:111                  0.0.0.0:*     users:(("rpcbind",pid=693,fd=5),("systemd",pid=1,fd=36))
udp   UNCONN     0      0                     0.0.0.0:35345                0.0.0.0:*     users:(("rpc.statd",pid=858,fd=7))
udp   UNCONN     0      0                        [::]:20048                   [::]:*     users:(("rpc.mountd",pid=894,fd=6))
udp   UNCONN     0      0                        [::]:48946                   [::]:*     users:(("rpc.statd",pid=858,fd=9))
udp   UNCONN     0      0                        [::]:111                     [::]:*     users:(("rpcbind",pid=693,fd=7),("systemd",pid=1,fd=38))
udp   UNCONN     0      0                       [::1]:323                     [::]:*     users:(("chronyd",pid=728,fd=6))
udp   UNCONN     0      0                        [::]:55867                   [::]:*
tcp   LISTEN     0      100                   0.0.0.0:324                  0.0.0.0:*     users:(("pimap4d",pid=2264,fd=7))
tcp   LISTEN     0      10                    0.0.0.0:322                  0.0.0.0:*     users:(("psmtpd",pid=1146204,fd=5))
tcp   LISTEN     0      10                    0.0.0.0:323                  0.0.0.0:*     users:(("ppop3d",pid=2973,fd=7))
tcp   LISTEN     0      10                    0.0.0.0:328                  0.0.0.0:*     users:(("pcrond",pid=2340,fd=3))
tcp   LISTEN     0      10                    0.0.0.0:329                  0.0.0.0:*     users:(("pmdad",pid=3509,fd=3))
tcp   LISTEN     0      4096                  0.0.0.0:49567                0.0.0.0:*     users:(("rpc.statd",pid=858,fd=8))
tcp   LISTEN     0      100                   0.0.0.0:110                  0.0.0.0:*     users:(("ppop3d",pid=2973,fd=3))
tcp   LISTEN     0      4096                  0.0.0.0:111                  0.0.0.0:*     users:(("rpcbind",pid=693,fd=4),("systemd",pid=1,fd=35))
tcp   LISTEN     0      10                    0.0.0.0:26                   0.0.0.0:*     users:(("psmtpd",pid=1146204,fd=3))
tcp   LISTEN     0      64                    0.0.0.0:2049                 0.0.0.0:*
tcp   LISTEN     0      100                   0.0.0.0:143                  0.0.0.0:*     users:(("pimap4d",pid=2264,fd=3))
tcp   LISTEN     0      10                    0.0.0.0:995                  0.0.0.0:*     users:(("ppop3d",pid=2973,fd=5))
tcp   LISTEN     0      100                   0.0.0.0:993                  0.0.0.0:*     users:(("pimap4d",pid=2264,fd=5))
tcp   LISTEN     0      220                   0.0.0.0:587                  0.0.0.0:*     users:(("wbsmtpd",pid=1286086,fd=4))
tcp   LISTEN     0      220                   0.0.0.0:3536                 0.0.0.0:*     users:(("wbsmtpd",pid=1286152,fd=3))
tcp   LISTEN     0      100                   0.0.0.0:3537                 0.0.0.0:*     users:(("wbcrond",pid=2293,fd=3))
tcp   LISTEN     0      220                   0.0.0.0:3535                 0.0.0.0:*     users:(("wbsmtpd",pid=1286086,fd=5))
tcp   LISTEN     0      64                    0.0.0.0:42197                0.0.0.0:*
tcp   LISTEN     0      4096                  0.0.0.0:20048                0.0.0.0:*     users:(("rpc.mountd",pid=894,fd=5))
tcp   LISTEN     0      100                         *:6443                       *:*     users:(("jsvc",pid=1134,fd=56))
tcp   LISTEN     0      4096                     [::]:111                     [::]:*     users:(("rpcbind",pid=693,fd=6),("systemd",pid=1,fd=37))
tcp   LISTEN     0      64                       [::]:2049                    [::]:*
tcp   LISTEN     0      100                         *:8443                       *:*     users:(("jsvc_lnx",pid=931,fd=169))
tcp   LISTEN     0      250                         *:3306                       *:*     users:(("mysqld",pid=1779,fd=30))
tcp   LISTEN     0      64                       [::]:40723                   [::]:*
tcp   LISTEN     0      4096                     [::]:20048                   [::]:*     users:(("rpc.mountd",pid=894,fd=7))
tcp   LISTEN     0      4096                     [::]:40485                   [::]:*     users:(("rpc.statd",pid=858,fd=10))
tcp   LISTEN     0      100                         *:18080                      *:*     users:(("jsvc_lnx",pid=931,fd=167))
```

```bash
# ss -nlptu
Netid         State          Recv-Q         Send-Q                  Local Address:Port                    Peer Address:Port         Process
udp           UNCONN         0              0                             0.0.0.0:38318                        0.0.0.0:*
udp           UNCONN         0              0                             0.0.0.0:20048                        0.0.0.0:*             users:(("rpc.mountd",pid=894,fd=4))
udp           UNCONN         0              0                             0.0.0.0:111                          0.0.0.0:*             users:(("rpcbind",pid=693,fd=5),("systemd",pid=1,fd=36))
udp           UNCONN         0              0                           127.0.0.1:323                          0.0.0.0:*             users:(("chronyd",pid=728,fd=5))
udp           UNCONN         0              0                             0.0.0.0:35345                        0.0.0.0:*             users:(("rpc.statd",pid=858,fd=7))
udp           UNCONN         0              0                           127.0.0.1:659                          0.0.0.0:*             users:(("rpc.statd",pid=858,fd=52))
udp           UNCONN         0              0                                [::]:20048                           [::]:*             users:(("rpc.mountd",pid=894,fd=6))
udp           UNCONN         0              0                                [::]:48946                           [::]:*             users:(("rpc.statd",pid=858,fd=9))
udp           UNCONN         0              0                                [::]:111                             [::]:*             users:(("rpcbind",pid=693,fd=7),("systemd",pid=1,fd=38))
udp           UNCONN         0              0                               [::1]:323                             [::]:*             users:(("chronyd",pid=728,fd=6))
udp           UNCONN         0              0                                [::]:55867                           [::]:*
tcp           LISTEN         0              100                           0.0.0.0:324                          0.0.0.0:*             users:(("pimap4d",pid=2264,fd=7))
tcp           LISTEN         0              10                            0.0.0.0:322                          0.0.0.0:*             users:(("psmtpd",pid=1146204,fd=5))
tcp           LISTEN         0              10                            0.0.0.0:323                          0.0.0.0:*             users:(("ppop3d",pid=2973,fd=7))
tcp           LISTEN         0              10                            0.0.0.0:328                          0.0.0.0:*             users:(("pcrond",pid=2340,fd=3))
tcp           LISTEN         0              10                            0.0.0.0:329                          0.0.0.0:*             users:(("pmdad",pid=3509,fd=3))
tcp           LISTEN         0              4096                          0.0.0.0:49567                        0.0.0.0:*             users:(("rpc.statd",pid=858,fd=8))
tcp           LISTEN         0              100                           0.0.0.0:110                          0.0.0.0:*             users:(("ppop3d",pid=2973,fd=3))
tcp           LISTEN         0              4096                          0.0.0.0:111                          0.0.0.0:*             users:(("rpcbind",pid=693,fd=4),("systemd",pid=1,fd=35))
tcp           LISTEN         0              128                           0.0.0.0:22                           0.0.0.0:*             users:(("sshd",pid=751,fd=3))
tcp           LISTEN         0              10                            0.0.0.0:26                           0.0.0.0:*             users:(("psmtpd",pid=1146204,fd=3))
tcp           LISTEN         0              220                           0.0.0.0:25                           0.0.0.0:*             users:(("wbsmtpd",pid=1286086,fd=3))
tcp           LISTEN         0              64                            0.0.0.0:2049                         0.0.0.0:*
tcp           LISTEN         0              100                           0.0.0.0:143                          0.0.0.0:*             users:(("pimap4d",pid=2264,fd=3))
tcp           LISTEN         0              10                            0.0.0.0:995                          0.0.0.0:*             users:(("ppop3d",pid=2973,fd=5))
tcp           LISTEN         0              100                           0.0.0.0:993                          0.0.0.0:*             users:(("pimap4d",pid=2264,fd=5))
tcp           LISTEN         0              220                           0.0.0.0:587                          0.0.0.0:*             users:(("wbsmtpd",pid=1286086,fd=4))
tcp           LISTEN         0              220                           0.0.0.0:3536                         0.0.0.0:*             users:(("wbsmtpd",pid=1286152,fd=3))
tcp           LISTEN         0              100                           0.0.0.0:3537                         0.0.0.0:*             users:(("wbcrond",pid=2293,fd=3))
tcp           LISTEN         0              220                           0.0.0.0:3535                         0.0.0.0:*             users:(("wbsmtpd",pid=1286086,fd=5))
tcp           LISTEN         0              64                            0.0.0.0:42197                        0.0.0.0:*
tcp           LISTEN         0              4096                          0.0.0.0:20048                        0.0.0.0:*             users:(("rpc.mountd",pid=894,fd=5))
tcp           LISTEN         0              100                                 *:6443                               *:*             users:(("jsvc",pid=1134,fd=56))
tcp           LISTEN         0              100                                 *:443                                *:*             users:(("jsvc_lnx",pid=365063,fd=176))
tcp           LISTEN         0              4096                             [::]:111                             [::]:*             users:(("rpcbind",pid=693,fd=6),("systemd",pid=1,fd=37))
tcp           LISTEN         0              100                                 *:80                                 *:*             users:(("jsvc_lnx",pid=365063,fd=174))
tcp           LISTEN         0              128                              [::]:22                              [::]:*             users:(("sshd",pid=751,fd=4))
tcp           LISTEN         0              64                               [::]:2049                            [::]:*
tcp           LISTEN         0              100                                 *:8443                               *:*             users:(("jsvc_lnx",pid=931,fd=169))
tcp           LISTEN         0              250                                 *:3306                               *:*             users:(("mysqld",pid=1779,fd=30))
tcp           LISTEN         0              64                               [::]:40723                           [::]:*
tcp           LISTEN         0              100                                 *:8080                               *:*             users:(("jsvc",pid=1134,fd=51))
tcp           LISTEN         0              4096                             [::]:20048                           [::]:*             users:(("rpc.mountd",pid=894,fd=7))
tcp           LISTEN         0              4096                             [::]:40485                           [::]:*             users:(("rpc.statd",pid=858,fd=10))
tcp           LISTEN         0              100                                 *:18080                              *:*             users:(("jsvc_lnx",pid=931,fd=167))
```

### 1.2 lsof 명령어
설명: 현재 LISTEN 상태 포트 + 사용중인 PID 표시
목적: 시스템에 열린 포트 및 실행중인 서비스 식별
```bash
# lsof -i -nP | grep -i listen
systemd         1     root   35u  IPv4   22028      0t0  TCP *:111 (LISTEN)
systemd         1     root   37u  IPv6   22030      0t0  TCP *:111 (LISTEN)
rpcbind       693      rpc    4u  IPv4   22028      0t0  TCP *:111 (LISTEN)
rpcbind       693      rpc    6u  IPv6   22030      0t0  TCP *:111 (LISTEN)
sshd          751     root    3u  IPv4   25129      0t0  TCP *:22 (LISTEN)
sshd          751     root    4u  IPv6   25138      0t0  TCP *:22 (LISTEN)
rpc.statd     858  rpcuser    8u  IPv4   25399      0t0  TCP *:49567 (LISTEN)
rpc.statd     858  rpcuser   10u  IPv6   25418      0t0  TCP *:40485 (LISTEN)
rpc.mount     894     root    5u  IPv4   25361      0t0  TCP *:20048 (LISTEN)
rpc.mount     894     root    7u  IPv6   25374      0t0  TCP *:20048 (LISTEN)
jsvc_lnx      931   tomcat  167u  IPv6   29768      0t0  TCP *:18080 (LISTEN)
jsvc_lnx      931   tomcat  169u  IPv6   30724      0t0  TCP *:8443 (LISTEN)
jsvc         1134 deepsoft   51u  IPv6   29463      0t0  TCP *:8080 (LISTEN)
jsvc         1134 deepsoft   56u  IPv6   28506      0t0  TCP *:6443 (LISTEN)
mysqld       1779    mysql   30u  IPv6   30449      0t0  TCP *:3306 (LISTEN)
pimap4d      2264 deepsoft    3u  IPv4   32082      0t0  TCP *:143 (LISTEN)
pimap4d      2264 deepsoft    5u  IPv4   32089      0t0  TCP *:993 (LISTEN)
pimap4d      2264 deepsoft    7u  IPv4   32113      0t0  TCP *:324 (LISTEN)
wbcrond      2293   tomcat    3u  IPv4   30327      0t0  TCP *:3537 (LISTEN)
pcrond       2340 deepsoft    3u  IPv4   31654      0t0  TCP *:328 (LISTEN)
ppop3d       2973 deepsoft    3u  IPv4   32723      0t0  TCP *:110 (LISTEN)
ppop3d       2973 deepsoft    5u  IPv4   32741      0t0  TCP *:995 (LISTEN)
ppop3d       2973 deepsoft    7u  IPv4   33144      0t0  TCP *:323 (LISTEN)
pmdad        3509 deepsoft    3u  IPv4   33558      0t0  TCP *:329 (LISTEN)
jsvc_lnx   365063 deepsoft  174u  IPv6 1407703      0t0  TCP *:80 (LISTEN)
jsvc_lnx   365063 deepsoft  176u  IPv6 1407706      0t0  TCP *:443 (LISTEN)
psmtpd    1146204 deepsoft    3u  IPv4 4052637      0t0  TCP *:26 (LISTEN)
psmtpd    1146204 deepsoft    5u  IPv4 4052639      0t0  TCP *:322 (LISTEN)
wbsmtpd   1295053   tomcat    3u  IPv4 4678299      0t0  TCP *:25 (LISTEN)
wbsmtpd   1295053   tomcat    4u  IPv4 4678300      0t0  TCP *:587 (LISTEN)
wbsmtpd   1295053   tomcat    5u  IPv4 4678301      0t0  TCP *:3535 (LISTEN)
wbsmtpd   1295214   tomcat    3u  IPv4 4678985      0t0  TCP *:3536 (LISTEN)
```

## 2. 실시간 패킷 감시 (tcpdump)
설명: 기존 포트를 제외한 모든 인터페이스의 패킷 감시
목적: BPFdoor가 사용하는 은밀한 포트/프로토콜 확인
```bash
# tcpdump -i any not port 22 and not port 25 and not port 80 and not port 443 -nn
```

설명: ICMP와 DNS 트래픽 감시
목적: ICMP 터널링, DNS 터널링을 통한 명령 수신 여부 확인
```bash
# tcpdump -i any icmp
tcpdump: data link type LINUX_SLL2
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
```

```bash
# tcpdump -i any port 53
tcpdump: data link type LINUX_SLL2
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
19:42:10.050970 ens160 Out IP mail.jkbaik.com.41287 > kns.kornet.net.domain: 17633+ A? resolver1.t.ctmail.com. (40)
19:42:10.054785 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.41287: 17633 2/0/0 CNAME resolver.1.geo.ctmail.com., A 158.51.79.244 (95)
19:42:10.055350 ens160 Out IP mail.jkbaik.com.41813 > kns.kornet.net.domain: 17040+ A? resolver2.t.ctmail.com. (40)
19:42:10.058652 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.41813: 17040 2/0/0 CNAME resolver.2.geo.ctmail.com., A 158.51.79.244 (95)
19:42:10.059203 ens160 Out IP mail.jkbaik.com.41268 > kns.kornet.net.domain: 15518+ A? resolver3.t.ctmail.com. (40)
19:42:10.061441 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.41268: 15518 2/0/0 CNAME resolver.3.geo.ctmail.com., A 158.51.79.244 (95)
19:42:10.061907 ens160 Out IP mail.jkbaik.com.47099 > kns.kornet.net.domain: 57610+ A? resolver4.t.ctmail.com. (40)
19:42:10.065439 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.47099: 57610 2/0/0 CNAME resolver.4.geo.ctmail.com., A 204.109.58.94 (95)
19:42:10.065890 ens160 Out IP mail.jkbaik.com.35541 > kns.kornet.net.domain: 2342+ A? resolver5.t.ctmail.com. (40)
19:42:10.068538 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.35541: 2342 2/0/0 CNAME resolver.5.geo.ctmail.com., A 158.51.79.230 (95)
19:42:10.073083 ens160 Out IP mail.jkbaik.com.50079 > kns.kornet.net.domain: 40891+ A? resolver1.t.ctmail.com. (40)
19:42:10.073304 ens160 Out IP mail.jkbaik.com.50079 > kns.kornet.net.domain: 61367+ AAAA? resolver1.t.ctmail.com. (40)
19:42:10.077638 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.50079: 40891 2/0/0 CNAME resolver.1.geo.ctmail.com., A 158.51.79.244 (95)
19:42:10.077658 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.50079: 61367 1/1/0 CNAME resolver.1.geo.ctmail.com. (149)
19:42:10.086465 ens160 Out IP mail.jkbaik.com.56246 > kns.kornet.net.domain: 44956+ PTR? 1.63.126.168.in-addr.arpa. (43)
19:42:10.089872 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.56246: 44956 1/0/0 PTR kns.kornet.net. (71)
19:42:11.856543 ens160 Out IP mail.jkbaik.com.55016 > kns.kornet.net.domain: 20688+ A? resolver2.t.ctmail.com. (40)
19:42:11.856820 ens160 Out IP mail.jkbaik.com.55016 > kns.kornet.net.domain: 47068+ AAAA? resolver2.t.ctmail.com. (40)
19:42:11.859203 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.55016: 20688 2/0/0 CNAME resolver.2.geo.ctmail.com., A 158.51.79.244 (95)
19:42:11.859227 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.55016: 47068 1/1/0 CNAME resolver.2.geo.ctmail.com. (149)
19:42:13.570569 ens160 Out IP mail.jkbaik.com.40173 > kns.kornet.net.domain: 22778+ A? resolver3.t.ctmail.com. (40)
19:42:13.570907 ens160 Out IP mail.jkbaik.com.40173 > kns.kornet.net.domain: 33535+ AAAA? resolver3.t.ctmail.com. (40)
19:42:13.574358 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.40173: 33535 1/1/0 CNAME resolver.3.geo.ctmail.com. (149)
19:42:13.574389 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.40173: 22778 2/0/0 CNAME resolver.3.geo.ctmail.com., A 158.51.79.244 (95)
19:42:23.573527 ens160 Out IP mail.jkbaik.com.52459 > kns.kornet.net.domain: 22302+ A? resolver4.t.ctmail.com. (40)
19:42:23.573780 ens160 Out IP mail.jkbaik.com.52459 > kns.kornet.net.domain: 18202+ AAAA? resolver4.t.ctmail.com. (40)
19:42:23.576202 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.52459: 22302 2/0/0 CNAME resolver.4.geo.ctmail.com., A 204.109.58.94 (95)
19:42:23.576225 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.52459: 18202 1/1/0 CNAME resolver.4.geo.ctmail.com. (149)
19:42:24.733895 ens160 Out IP mail.jkbaik.com.38851 > kns.kornet.net.domain: 13704+ A? resolver5.t.ctmail.com. (40)
19:42:24.734303 ens160 Out IP mail.jkbaik.com.38851 > kns.kornet.net.domain: 20213+ AAAA? resolver5.t.ctmail.com. (40)
19:42:24.737667 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.38851: 13704 2/0/0 CNAME resolver.5.geo.ctmail.com., A 158.51.79.230 (95)
19:42:24.738024 ens160 In  IP kns.kornet.net.domain > mail.jkbaik.com.38851: 20213 1/1/0 CNAME resolver.5.geo.ctmail.com. (149)
```

## 3. 은폐 프로세스 및 실행 파일 확인
설명: 최근 실행된 프로세스 확인
목적: 시스템 시작 후 몰래 동작 중인 백도어 탐색
```bash
# ps auxf --sort=start_time | tail -n 20
deepsoft    2243  0.0  0.0 105856  1872 ?        S    Apr28   0:00  \_ (sd-pam)
deepsoft    2249  0.0  0.0  22400  2200 ?        S    Apr28   0:23 /usr/local/DEEPSoft/Postian//service/smtp/psmtpd
deepsoft    2258  0.0  0.0  19976  3340 ?        S    Apr28   0:55 /usr/local/DEEPSoft/Postian//service/pop3/ppop3d
deepsoft    2262  0.0  0.0  20296  3468 ?        S    Apr28   0:55 /usr/local/DEEPSoft/Postian//service/imap4/pimap4d
deepsoft    2264  0.0  0.3 145764 11804 ?        Sl   Apr28   1:14 pimap4d -d
tomcat      2293  0.1  0.1  21836  4352 ?        Sl   Apr28  12:34 wbcrond -d
deepsoft    2340  0.0  0.1  36044  4608 ?        Sl   Apr28   8:08 pcrond -d
deepsoft    2973  0.0  0.2 163648 11020 ?        Sl   Apr28   1:16 ppop3d -d
deepsoft    3509  0.0  0.1 271380  5524 ?        Sl   Apr28   1:35 pmdad -d
tomcat      5043  0.0  0.0  17972  3328 ?        S    Apr28   0:17 /usr/local/DEEPSoft/WBlockG5/bin/wbnotifymng -l
deepsoft    5050  0.0  0.0  15228  2688 ?        S    Apr28   0:05 cronmnt -d
root      148962  0.0  0.1  20864  6016 ?        Ss   Apr29   0:00 /usr/lib/systemd/systemd --user
root      148964  0.0  0.0 105900  2040 ?        S    Apr29   0:00  \_ (sd-pam)
root      365062  0.0  0.0   2612   896 ?        Ss   Apr30   0:00 jsvc.exec -jvm server -user deepsoft -home /usr/local/DEEPSoft/Postian/misc/jre1.8.0_202/ -Dcatalina.home=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100/ -Dcatalina.base=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100/ -Djava.io.tmpdir=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//temp -Djava.awt.headless=true -Duser.timezone=JST -Dfile.encoding=UTF-8 -Dfile.client.encoding=UTF-8 -Dclient.encoding.override=UTF-8 -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//conf/logging.properties -Dorg.apache.jasper.runtime.JspFactoryImpl.USE_POOL=false -Dorg.apache.jasper.runtime.BodyContentImpl.LIMIT_BUFFER=true -Dorg.apache.el.parser.SKIP_IDENTIFIER_CHECK=true -Xms512m -Xmx1024m -XX:NewSize=256m -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -Xloggc:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//logs/gc_%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=50m -wait 10 -pidfile /usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//jsvc.pid -outfile /usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//logs/catalina.out -errfile &1 -cp /usr/local/DEEPSoft/Postian/misc/jre1.8.0_202//lib/tools.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/commons-daemon.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/bootstrap.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/tomcat-juli.jar org.apache.catalina.startup.Bootstrap
deepsoft  365063  0.1  9.7 1538052 360896 ?      Sl   Apr30  11:22  \_ jsvc.exec -jvm server -user deepsoft -home /usr/local/DEEPSoft/Postian/misc/jre1.8.0_202/ -Dcatalina.home=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100/ -Dcatalina.base=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100/ -Djava.io.tmpdir=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//temp -Djava.awt.headless=true -Duser.timezone=JST -Dfile.encoding=UTF-8 -Dfile.client.encoding=UTF-8 -Dclient.encoding.override=UTF-8 -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//conf/logging.properties -Dorg.apache.jasper.runtime.JspFactoryImpl.USE_POOL=false -Dorg.apache.jasper.runtime.BodyContentImpl.LIMIT_BUFFER=true -Dorg.apache.el.parser.SKIP_IDENTIFIER_CHECK=true -Xms512m -Xmx1024m -XX:NewSize=256m -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -Xloggc:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//logs/gc_%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=50m -wait 10 -pidfile /usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//jsvc.pid -outfile /usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//logs/catalina.out -errfile &1 -cp /usr/local/DEEPSoft/Postian/misc/jre1.8.0_202//lib/tools.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/commons-daemon.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/bootstrap.jar:/usr/local/DEEPSoft/Postian/misc/apache-tomcat-8.5.100//bin/tomcat-juli.jar org.apache.catalina.startup.Bootstrap
deepsoft 1146204  0.0  2.5 752736 93508 ?        Sl   03:01   0:32 psmtpd -d
root     1226121  0.0  0.4 255224 15232 ?        Ssl  11:49   0:04 /usr/sbin/NetworkManager --no-daemon
tomcat   1296961  0.1  0.2  29080  9096 ?        S    19:45   0:00 /usr/local/DEEPSoft/WBlockG5/service/smtp/wbsmtpd
tomcat   1296967 14.0 17.3 884180 644692 ?       Sl   19:45   0:30 wbsmtpd -d
tomcat   1297039  0.1  0.2  53148  9856 ?        Sl   19:45   0:00 wbsmtpd -q d
```

## 4. 자동 실행 탐지 (cron)
설명: 사용자/시스템에 설정된 예약 실행 목록 출력
목적: 정기 실행형 백도어 스크립트 확인
```bash
# crontab -l
0 * * * * /usr/bin/chronyc makestep && /sbin/hwclock --systohc
```

## 5. 커널 모듈/라이브러리 후킹 감지
### 5.1 lsmod 명령어
설명: 로딩된 커널 모듈 목록
목적: 커널 레벨 루트킷 감지
```bash
# lsmod
Module                  Size  Used by
binfmt_misc            28672  1
nfnetlink              20480  0
bluetooth            1101824  0
tls                   159744  0
rpcrdma               425984  2
rdma_cm               155648  1 rpcrdma
iw_cm                  69632  1 rdma_cm
ib_cm                 155648  1 rdma_cm
ib_core               528384  4 rdma_cm,rpcrdma,iw_cm,ib_cm
snd_seq_midi           20480  0
snd_seq_midi_event     16384  1 snd_seq_midi
snd_ens1371            36864  0
intel_rapl_msr         20480  0
snd_ac97_codec        200704  1 snd_ens1371
intel_rapl_common      45056  1 intel_rapl_msr
ac97_bus               16384  1 snd_ac97_codec
snd_seq               131072  2 snd_seq_midi,snd_seq_midi_event
intel_uncore_frequency_common    16384  0
snd_pcm               184320  2 snd_ac97_codec,snd_ens1371
intel_pmc_core        118784  0
intel_vsec             20480  1 intel_pmc_core
pmt_telemetry          16384  1 intel_pmc_core
pmt_class              16384  1 pmt_telemetry
rapl                   28672  0
vmw_balloon            28672  0
vmwgfx                450560  0
snd_timer              53248  2 snd_seq,snd_pcm
drm_ttm_helper         16384  1 vmwgfx
ttm                    98304  2 vmwgfx,drm_ttm_helper
pcspkr                 16384  0
snd_rawmidi            53248  2 snd_seq_midi,snd_ens1371
snd_seq_device         16384  3 snd_seq,snd_seq_midi,snd_rawmidi
drm_kms_helper        245760  3 vmwgfx
snd                   147456  7 snd_seq,snd_seq_device,snd_timer,snd_ac97_codec,snd_pcm,snd_rawmidi,snd_ens1371
vmw_vmci              131072  1 vmw_balloon
syscopyarea            16384  1 drm_kms_helper
sysfillrect            16384  1 drm_kms_helper
sysimgblt              16384  1 drm_kms_helper
i2c_piix4              32768  0
fb_sys_fops            16384  1 drm_kms_helper
soundcore              16384  1 snd
rfkill                 40960  2 bluetooth
joydev                 28672  0
nfsd                  958464  5
auth_rpcgss           196608  1 nfsd
nfs_acl                16384  1 nfsd
lockd                 196608  1 nfsd
drm                   741376  5 vmwgfx,drm_kms_helper,drm_ttm_helper,ttm
fuse                  212992  1
grace                  16384  2 nfsd,lockd
sunrpc                851968  19 nfsd,rpcrdma,auth_rpcgss,lockd,nfs_acl
xfs                  2510848  2
libcrc32c              16384  1 xfs
sr_mod                 28672  0
cdrom                  90112  1 sr_mod
sg                     53248  0
ata_generic            16384  0
ata_piix               45056  0
crct10dif_pclmul       16384  1
crc32_pclmul           16384  0
crc32c_intel           24576  1
nvme                   65536  3
libata                479232  2 ata_piix,ata_generic
nvme_core             221184  4 nvme
ghash_clmulni_intel    16384  0
vmxnet3                94208  0
nvme_common            24576  1 nvme_core
t10_pi                 24576  1 nvme_core
serio_raw              20480  0
dm_mirror              32768  0
dm_region_hash         28672  1 dm_mirror
dm_log                 28672  2 dm_region_hash,dm_mirror
dm_mod                237568  9 dm_log,dm_mirror
```

### 5.2 환경변수 라이브러리 훅킹 여부 확인
설명: 환경변수로 라이브러리를 훅킹 했는지 확인
목적: 프로세스 감시 우회 기법 탐지
```bash
# grep -R LD_PRELOAD /etc/* 2>/dev/null
/etc/sudo.conf:# support LD_PRELOAD or its equivalent.
```

## 6. OS 로그 분석 - 직접 로그인 / 침투 여부 확인
설명: root 계정 사용 흔적
목적: 직접 로그인/침입 시도 여부 추적
```bash
# grep "root" /var/log/secure
May  4 09:52:26 localhost sshd[1207549]: Accepted password for root from 192.168.10.161 port 59508 ssh2
May  4 09:52:26 localhost sshd[1207549]: pam_unix(sshd:session): session opened for user root(uid=0) by root(uid=0)
May  4 09:52:26 localhost sshd[1207551]: Accepted password for root from 192.168.10.161 port 59509 ssh2
```

## 7. Wireshark(.pcap) 후분석
설명: 감지된 이상 트래픽을 .pcap 파일로 저장 후 Wireshark로 후분석
아래 8484 포트는 테스트로 출력한 내용
```bash
# tcpdump -r /var/log/suspicious.pcap port 8484
reading from file /var/log/suspicious.pcap, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144
Warning: interface names might be incorrect
dropped privs to tcpdump
20:17:02.060545 ens160 Out IP mail.jkbaik.com.34130 > 211.115.206.69.8484: Flags [S], seq 4085719892, win 32120, options [mss 1460,sackOK,TS val 2594570411 ecr 0,nop,wscale 7], length 0
20:17:02.071797 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.34130: Flags [S.], seq 1171899497, ack 4085719893, win 28960, options [mss 1460,sackOK,TS val 3071877611 ecr 2594570411,nop,wscale 7], length 0
20:17:02.071876 ens160 Out IP mail.jkbaik.com.34130 > 211.115.206.69.8484: Flags [.], ack 1, win 251, options [nop,nop,TS val 2594570423 ecr 3071877611], length 0
20:17:02.072346 ens160 Out IP mail.jkbaik.com.34130 > 211.115.206.69.8484: Flags [P.], seq 1:134, ack 1, win 251, options [nop,nop,TS val 2594570423 ecr 3071877611], length 133
20:17:02.083340 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.34130: Flags [.], ack 134, win 235, options [nop,nop,TS val 3071877621 ecr 2594570423], length 0
20:17:02.086951 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.34130: Flags [.], seq 1:1449, ack 134, win 235, options [nop,nop,TS val 3071877624 ecr 2594570423], length 1448
20:17:02.086992 ens160 Out IP mail.jkbaik.com.34130 > 211.115.206.69.8484: Flags [.], ack 1449, win 249, options [nop,nop,TS val 2594570438 ecr 3071877624], length 0
20:17:02.087220 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.34130: Flags [FP.], seq 1449:2457, ack 134, win 235, options [nop,nop,TS val 3071877624 ecr 2594570423], length 1008
20:17:02.087669 ens160 Out IP mail.jkbaik.com.34130 > 211.115.206.69.8484: Flags [F.], seq 134, ack 2458, win 249, options [nop,nop,TS val 2594570439 ecr 3071877624], length 0
20:17:02.098442 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.34130: Flags [.], ack 135, win 235, options [nop,nop,TS val 3071877635 ecr 2594570439], length 0
20:17:04.578794 ens160 Out IP mail.jkbaik.com.54372 > 211.115.206.69.8484: Flags [S], seq 2605180140, win 32120, options [mss 1460,sackOK,TS val 2594572930 ecr 0,nop,wscale 7], length 0
20:17:04.598612 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.54372: Flags [S.], seq 2250992794, ack 2605180141, win 28960, options [mss 1460,sackOK,TS val 3071879935 ecr 2594572930,nop,wscale 7], length 0
20:17:04.598717 ens160 Out IP mail.jkbaik.com.54372 > 211.115.206.69.8484: Flags [.], ack 1, win 251, options [nop,nop,TS val 2594572950 ecr 3071879935], length 0
20:17:04.599318 ens160 Out IP mail.jkbaik.com.54372 > 211.115.206.69.8484: Flags [P.], seq 1:146, ack 1, win 251, options [nop,nop,TS val 2594572950 ecr 3071879935], length 145
20:17:04.620357 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.54372: Flags [.], ack 146, win 235, options [nop,nop,TS val 3071879954 ecr 2594572950], length 0
20:17:04.622897 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.54372: Flags [.], seq 1:1449, ack 146, win 235, options [nop,nop,TS val 3071879957 ecr 2594572950], length 1448
20:17:04.623003 ens160 Out IP mail.jkbaik.com.54372 > 211.115.206.69.8484: Flags [.], ack 1449, win 249, options [nop,nop,TS val 2594572974 ecr 3071879957], length 0
20:17:04.623305 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.54372: Flags [FP.], seq 1449:2725, ack 146, win 235, options [nop,nop,TS val 3071879957 ecr 2594572950], length 1276
20:17:04.623825 ens160 Out IP mail.jkbaik.com.54372 > 211.115.206.69.8484: Flags [F.], seq 146, ack 2726, win 249, options [nop,nop,TS val 2594572975 ecr 3071879957], length 0
20:17:04.643105 ens160 In  IP 211.115.206.69.8484 > mail.jkbaik.com.54372: Flags [.], ack 147, win 235, options [nop,nop,TS val 3071879976 ecr 2594572975], length 0
```

# Conclusion
- OS에 설치되어 있는 WAS 애플리케이션에서 가능한 확인 방법은 수상한 IP의 접속 이력 등을 확인해보는 방법이 있음.
- 그래 다 털어가라.

